(function(d,k){function l(a){var b=this;this.$element=a.$element;if(a.options.socket===k)throw"A socket must be passed as an argument to use liveSortable.";this.socket=a.options.socket;d.each(a.customEvents,function(c,d){a.options.cancelRealtime&&"moving"===c||b.addEvent(d)});return this}function h(a,b){this.$element=d(a);this.options=d.extend({},g,b);this.events=d.extend({},g.events,this.options.events);this.sortableOptions=d.extend({},g.sortable,this.options.sortable);this.$element.sortable(this.sortableOptions);
this.customEvents=e.create(this);this._socketEventer=new l(this);this.getSocket=function(){return this._socketEventer.socket};this.options.cancelSendingInRealtime||this.addMousemoveHandler();return this}if(d===k)throw"jQuery should be defined to use liveSortable";if(!("sortable"in d.fn))throw"jQuery UIs sortable should be defined to use liveSortable";var g={cancelRealtime:!1,cancelSendingInRealtime:!1,delay:0,events:{start:function(){},beforeStop:function(){},stop:function(){},mousemove:function(){}},
eventNames:{started:"move_started",moving:"moving_element",ended:"move_ended"},sortable:{helper:"clone",start:function(a,b){var c=h.getInstanceFrom(this),d=c.getSocket(),f=c.events.start(a,b,c)||{id:b.item.get(0).id};d.emit(e.addBroadcast(c.customEvents.started),f);c.isBeingDragged=!0},beforeStop:function(a,b){var c=h.getInstanceFrom(this),d=c.getSocket(),f=c.events.beforeStop(a,b,c);if(!f)var f=b.item,g=f.next().get(0),k=f.prev().get(0),f={id:f.get(0).id,next:g&&g.id,prev:k&&k.id};d.emit(e.addBroadcast(c.customEvents.ended),
f)},stop:function(a,b){var c=h.getInstanceFrom(this);c.events.stop(a,b,c);c.isBeingDragged=!1}}},e={sufix:".liveSortable",addSufix:function(a){return a+e.sufix},addBroadcast:function(a){return"broadcast_"+a},create:function(a){var b={started:"",moving:"",ended:""};d.each(b,function(c,d){b[c]=e.addSufix(a.options.eventNames[c]||g.eventNames[c])});return b}};l.prototype={eventHandlers:{},addEvent:function(a){var b=this,c=function(c){b.$element.trigger(a,c)};this.eventHandlers[a]=c;this.socket.on(a,
c)},removeEvent:function(a){this.socket.removeListener(a,this.eventHandlers[a])},removeAllEvents:function(){for(var a in this.eventHandlers)this.eventHandlers.hasOwnProperty(a)&&this.removeEvent(a)}};h.prototype={isBeingDragged:!1,addMousemoveHandler:function(){var a=this;return this.$element.on(e.addSufix("mousemove"),function(b){a.isBeingDragged&&(b=a.events.mousemove(b,a),b||(b=a.$element.children(".ui-sortable-helper").get(0),b={id:b.id,top:b.style.top,left:b.style.left}),a._socketEventer.socket.emit(e.addBroadcast(a.customEvents.moving),
b),0<a.options.delay&&(a.removeMousemoveHandler(),setTimeout(function(){a.addMousemoveHandler()},a.options.delay)))})},removeMousemoveHandler:function(){return this.$element.off(e.addSufix("mousemove"))},remove:function(){this.$element.removeData("plugin_liveSortable").off(e.sufix);this._socketEventer.removeAllEvents();return this.$element},toggleOption:function(a){this.options[a]=!this.options[a];return this.options[a]},toggleRealtime:function(){var a=this.customEvents.moving;this.toggleOption("cancelRealtime")?
this._socketEventer.removeEvent(a):this._socketEventer.addEvent(a)},toggleRealtimeSending:function(){this.toggleOption("cancelSendingInRealtime")?this.removeMousemoveHandler():this.addMousemoveHandler()},delay:function(a){this.options.delay=a}};h.getInstanceFrom=function(a){return d(a).data("plugin_liveSortable")};d.fn.liveSortable=function(a){var b="string"===typeof a;if(b)var c=Array.prototype.slice.call(arguments,1);return this.each(function(){if(b){var e=d.data(this,"plugin_liveSortable");if(!e)throw"Method called on liveSortable before instantiation";
if(!d.isFunction(e[a]))throw"The method: "+a+" was not found in liveSortable";e[a].apply(e,c)}else d.data(this,"plugin_liveSortable")||d.data(this,"plugin_liveSortable",new h(this,a))})}})(jQuery);