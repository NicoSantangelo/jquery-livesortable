(function(d,g){function l(a){var b=this;this.$element=a.$element;if(a.options.socket===g)throw"A socket must be passed as an argument to use liveSortable.";this.socket=a.options.socket;d.each(a.customEvents,function(a,e){b.addEvent(e)});return this}function h(a,b){this.$element=d(a);this.options=d.extend({},k,b);this.events=d.extend({},k.events,this.options.events);this.sortableOptions=d.extend({},k.sortable,this.options.sortable);this.$element.sortable(this.sortableOptions);this.customEvents=f.create(this);
this._socketEventer=new l(this);this.getSocket=function(){return this._socketEventer.socket};this.options.cancelSedingInRealtime||this.addMousemoveHandler();return this}if(d===g)throw"jQuery should be defined to use liveSortable";if(!("sortable"in d.fn))throw"jQuery UIs sortable should be defined to use liveSortable";var k={cancelRealtime:!1,cancelSedingInRealtime:!1,delay:0,events:{start:function(){},beforeStop:function(){},stop:function(){},mousemove:function(){}},sortable:{helper:"clone",start:function(a,
b){var c=h.getInstanceFrom(this),e=c.getSocket(),d=c.events.start(a,b,c)||{id:b.item.get(0).id};e.emit(f.addSufix("broadcast_move_started"),d);c.isBeingDragged=!0},beforeStop:function(a,b){var c=h.getInstanceFrom(this),d=c.getSocket(),c=c.events.beforeStop(a,b,c);if(!c)var c=b.item,g=c.next().get(0),k=c.prev().get(0),c={id:c.get(0).id,next:g&&g.id,prev:k&&k.id};d.emit(f.addSufix("broadcast_move_ended"),c)},stop:function(a,b){var c=h.getInstanceFrom(this);c.events.stop(a,b,c);c.isBeingDragged=!1}}},
f={sufix:".liveSortable",addSufix:function(a){return a+f.sufix},create:function(a){var b=["move_element","move_started","move_ended"];a.options.cancelRealtime&&(b=b.slice(1));return d.map(b,this.addSufix)}};l.prototype={eventHandlers:{},addEvent:function(a){var b=this,c=function(c){b.$element.trigger(a,c)};this.eventHandlers[a]=c;this.socket.on(a,c)},removeEvent:function(a){this.socket.removeListener(a,this.eventHandlers[a])},removeAllEvents:function(){for(var a in this.eventHandlers)this.eventHandlers.hasOwnProperty(a)&&
this.removeEvent(a)}};h.prototype={isBeingDragged:!1,addMousemoveHandler:function(){var a=this;return this.$element.on(f.addSufix("mousemove"),function(b){a.isBeingDragged&&(b=a.events.mousemove(b,a),b||(b=a.$element.children(".ui-sortable-helper").get(0),b={id:b.id,top:b.style.top,left:b.style.left}),a._socketEventer.socket.emit(f.addSufix("broadcast_moving_element"),b),0<a.options.delay&&(a.removeMousemoveHandler(),setTimeout(function(){a.addMousemoveHandler()},a.options.delay)))})},removeMousemoveHandler:function(){return this.$element.off(f.addSufix("mousemove"))},
remove:function(){this.$element.removeData("plugin_liveSortable").off(f.sufix);this._socketEventer.removeAllEvents();return this.$element},toggleOption:function(a){this.options[a]=!this.options[a];return this.options[a]},toggleRealtime:function(){var a=f.addSufix("move_element");this.toggleOption("cancelRealtime")?this._socketEventer.removeEvent(a):this._socketEventer.addEvent(a)},toggleRealtimeSending:function(){this.toggleOption("cancelSedingInRealtime")?this.removeMousemoveHandler():this.addMousemoveHandler()},
delay:function(a){this.options.delay=a}};h.getInstanceFrom=function(a){return d(a).data("plugin_liveSortable")};d.fn.liveSortable=function(a){var b="string"===typeof a;if(b)var c=Array.prototype.slice.call(arguments,1);return this.each(function(){if(b){var e=d.data(this,"plugin_liveSortable");if(!e)throw"Method called on liveSortable before instantiation";if(!d.isFunction(e[a]))throw"The method: "+a+" was not found in liveSortable";e=e[a].apply(e,c);if(e!==g)return e}else d.data(this,"plugin_liveSortable")||
d.data(this,"plugin_liveSortable",new h(this,a))})}})(jQuery);